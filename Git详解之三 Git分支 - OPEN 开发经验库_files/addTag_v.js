/*! 3632 2013-9-17 14:8:14 */
define(["lib/jquery/1_9","lib/jh","kit/loadElm","kit/buildUiEvent","kit/fixBoxImg","comp/tagStrOperate"],function(e,t,n,i,a,o){var r=function(r){var s={},l={},c=function(){s.controller=r,l.dom=e(s.layoutHtml)[0],n(l.dom,s),s.bindUiEvent(),setTimeout(function(){s.node.tagInput.focus()},500),s.listenInputContent()};return s.bindUiEvent=function(){i(l.dom,[["click","._tagBtn"],["keypress keydown","#tagInput"],["click",".__closeBtn"],["click",".__saveTagBtn"],["focus","#tagInput"],["blur","#tagInput"]],s.uiEvent,e),e(s.node.tagListForm).on("submit",function(e){e.preventDefault(),l.goSave()})},s.uiEvent={click_tagBtn:function(t){t.preventDefault(),l.addTagToInput(e(this).find("._tagBtnText")[0].firstChild.data),s.checkInput()},keypress_keydown__tagInput:function(){s.checkInput()},click__saveTagBtn:function(e){e.preventDefault(),l.goSave()},click__closeBtn:function(e){e.preventDefault(),s.controller.close()},focus__tagInput:function(){e(s.node.tagInput).addClass("text-input-focus")},blur__tagInput:function(){e(s.node.tagInput).removeClass("text-input-focus")}},s.layoutHtml='<div class="addTagsActivity __addTagsActivity"><div class="title"></div><div class="content __content clearfix"><div class="pic-list-box __picListBox" style="display:none;"><div class="pic-list __picList"></div><div class="pic-list-box-border @more-pic __picBorder"><span class="pic-list-num __picNum"></span></div></div><div class="operate"><form method="post" action="#" id="tagListForm"><div class="operate-body"><div class="tag-input"><label for="tagInput" class="title">标签: </label><input type="text" id="tagInput" class="text-input" /></div><div class="tag-commend __tagCommend" style="display:none;"><span class="title">我的标签: </span><div class="tag-list __tagList"></div></div><a href="#" class="__saveTagBtn save-tag-btn sc-btn" type="submit"><span>保存</span></a><a href="#" class="__closeBtn close-btn sc-btn" type="submit"><span>关闭</span></a></div></form></div></div></div>',s.renderPicShow=function(e){var n="",i=a({width:56,height:56});t.forEach(e,function(e){var t=i.fix(null,{width:e.width,height:e.height});n+='<span class="pic"><img width="'+t.width+'" height="'+t.height+'" src="'+e.res_src+'" alt="" /></span>'}),s.node.picList.innerHTML=n},s.renderPicNum=function(t){s.node.picNum.innerHTML=t,t>1?(t>99&&e(s.node.picBorder).addClass("more-pic-3"),e(s.node.picBorder).addClass("more-pic")):e(s.node.picBorder).removeClass("more-pic")},s.checkInput=function(){s.isBlank(s.node.tagInput.value)?e(s.node.content).removeClass("has-input-value"):e(s.node.content).addClass("has-input-value")},s.listenInputContent=function(){var e=setInterval(function(){try{s.checkInput()}catch(t){alert(t),clearInterval(e)}},500)},s.isBlank=function(e){return!t.trim(e)},s.renderTagList=function(e){var n="";t.forEach(e,function(e){n+='<a href="#" class="tag-btn _tagBtn"><span><span class="_tagBtnText">'+e+"</span></span></a> "}),s.node.tagList.innerHTML=n},l.addTagToInput=function(e){s.node.tagInput.value=o.add(s.node.tagInput.value,e)},l.bindTags=function(e){var t=[];e.aTagList=e.aTagList.sort(function(e,t){return e.num>t.num?-1:1});var n,i;for(n=0,i=e.aTagList.length;i>n;++n)t.push(e.aTagList[n].tag);s.renderTagList(t),t.length&&(s.node.tagCommend.style.display="block")},l.bindData=function(t){"image"===t.type&&(e(s.node.picListBox).show(),s.renderPicShow(t.aPicShowList),s.renderPicNum(t.iPicNum))},l.goSave=function(){var t=s.node.tagInput.value,n=o.toArray(t),i=[];return n.length>8?(alert("最多可输入8个标签"),void 0):(e(n).each(function(e,t){t.length<20&&i.push(t)}),i.length===n.length?s.controller.saveTag({sTagList:n.join(",")}):alert("单个标签不能超过20个字"),!1)},c(),l};return r});